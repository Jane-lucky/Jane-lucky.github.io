---
title: middleware——中间件
categories: 
- [golang, gin框架]
---

# middleware

## 概念

中间件处理处理程序是简单的http.Handler,它包装另一个http.Handler

作请求的一些预处理和或后处理，被称为中间件。

每个中间件只处理一件事情，完成后将其传递给另一个中间件或者最终处理程序，可以做到程序的解耦，减少程序的冗余和降低代码复用率。

## 应用

常见的用例：请求如之记录、header操纵、http请求认证和Responseriter劫持等等。

- 记录对服务器发送的请求
- 处理服务器响应
- 请求和处理之间做一个权限认证工作
- 远程调用
- 安全

## example

### 单中间件

```go
package main

import (
	"fmt"
	"log"
	"net/http"
)

//"github.com/gin-gonic/gin"

func logging(f http.HandlerFunc) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		log.Println(r.URL.Path)
		f(w, r)
	}
}

func foo(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "foo")
}

func bar(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "bar")
}

func loggingMiddleWare(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		log.Println(r.URL.Path)
		next.ServeHTTP(w, r)
	})
}
func main() {
	http.Handle("/foo", loggingMiddleWare(http.HandlerFunc(foo)))
	http.Handle("/bar", loggingMiddleWare(http.HandlerFunc(bar)))
	//http.HandleFunc("/foo", logging(foo))
	//http.HandleFunc("/bar", logging(bar))
	http.ListenAndServe(":8080", nil)
}
```

### 多中间件

中间件将方法作为参数之一，包装并返回一个新的方法服务器，定义一种新的MiddlWare，容易将多个中间件连接起来

```go
package main

import (
	"fmt"
	"log"
	"net/http"
	"time"
)

//"github.com/gin-gonic/gin"

type MiddleWare func(http.HandlerFunc) http.HandlerFunc

type MiddleWare1 func(http.Handler) http.Handler

//日志打印
func logging() MiddleWare1 {
	return func(h http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			start := time.Now()
			defer func() {
				log.Println(r.URL.Path)
				time.Since(start)
			}()
			h.ServeHTTP(w, r)
		})
	}
}

func method(m string) MiddleWare1 {
	return func(h http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			if r.Method != m {
				http.Error(w, http.StatusText(http.StatusBadRequest), http.StatusBadRequest)
			}
			h.ServeHTTP(w, r)
		})
	}
}

func chain1(f http.Handler, middlewares ...MiddleWare1) http.Handler {
	for _, m := range middlewares {
		f = m(f)
	}
	return f
}

func Logging() MiddleWare {
	return func(hf http.HandlerFunc) http.HandlerFunc {
		return func(w http.ResponseWriter, r *http.Request) {
			start := time.Now()

			defer func() {
				log.Println(r.URL.Path)
				time.Since(start)
			}()
			hf(w, r)
		}

	}
}

func Method(m string) MiddleWare {
	return func(hf http.HandlerFunc) http.HandlerFunc {
		return func(w http.ResponseWriter, r *http.Request) {
			if r.Method != m {
				http.Error(w, http.StatusText(http.StatusBadRequest), http.StatusBadRequest)
			}
			hf(w, r)
		}
	}
}

func chain(f http.HandlerFunc, middlewares ...MiddleWare) http.HandlerFunc {
	for _, m := range middlewares {
		f = m(f)
	}
	return f
}

func Hello(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "hello world")
}

func main() {
	http.Handle("/test", chain1(http.HandlerFunc(Hello), method("GET"), logging()))
	http.HandleFunc("/", chain(Hello, Method("GET"), Logging()))
	http.ListenAndServe(":8080", nil)
}

```

### gin中间件

```go
r:=gin.Default()//创建带有默认的中间件路由（包含logger和recovery）
r:=gin.new()//创建没有中间件的路由
```

两种中间件方式，后续展示第二种

```
package main

import (
	"fmt"
	"log"
	"time"

	"github.com/gin-gonic/gin"
)

//"github.com/gin-gonic/gin"

/**
自定义日志中间件第一种方式-----请求之前
自定义日志中间件第一种方式-----请求之后
2022/08/31 15:40:57 12345
2022/08/31 15:40:57 64.542µs
2022/08/31 15:40:57 200
**/
func Logger() gin.HandlerFunc {
	return func(ctx *gin.Context) {
		t := time.Now()
		fmt.Println("自定义日志中间件第一种方式-----请求之前")
		//在gin上下文定义一个变量
		ctx.Set("example", "12345")
		//请求之前
		ctx.Next()
		fmt.Println("自定义日志中间件第一种方式-----请求之后")
		//计算整个请求过程
		latency := time.Since(t)
		log.Print(latency)

		//请求状态打印
		status := ctx.Writer.Status()
		log.Println(status)
	}
}

/**
自定义日志中间件第二种方式-----请求之前
自定义日志中间件第二种方式-----请求之后
2022/08/31 15:40:17 12345
2022/08/31 15:40:17 60.112µs
2022/08/31 15:40:17 200
**/
func Logger1(c *gin.Context) {
	t := time.Now()
	fmt.Println("自定义日志中间件第二种方式-----请求之前")
	//在gin上下文定义一个变量
	c.Set("example", "12345")
	//请求之前
	c.Next()
	fmt.Println("自定义日志中间件第二种方式-----请求之后")
	//计算整个请求过程
	latency := time.Since(t)
	log.Print(latency)

	//请求状态打印
	status := c.Writer.Status()
	log.Println(status)
}
func main() {
	r := gin.New()
	r.Use(Logger())
	//r.Use(Logger1)
	r.GET("/test", func(ctx *gin.Context) {
		exam := ctx.MustGet("example").(string)
		log.Println(exam)
	})
	r.Run()
}

```

**路由器中间件**

```go
package main

import (
	"fmt"

	"github.com/gin-gonic/gin"
)

func RouterMiddle1(c *gin.Context) {
	fmt.Println("路由中间1")
}

func RouterMiddle2(c *gin.Context) {
	fmt.Println("路由中间2")
}

func onRouterMiddleHandle() gin.HandlerFunc {
	return func(ctx *gin.Context) {
		fmt.Println("业务处理")
	}
}
func main() {
	r := gin.New()
	/**
	路由中间1
	路由中间2
	业务处理
	*/
	r.GET("/onRouterMiddle", RouterMiddle1, RouterMiddle2, onRouterMiddleHandle())
	r.Run()
}
```

**路由组中间件**

```go
package main

import (
	"fmt"

	"github.com/gin-gonic/gin"
)

//路由组中间件
func GroupRouterGoodsMiddle1(c *gin.Context) {
	fmt.Println("goods路由组中间件1")
}

func GroupRouterGoodsMiddle2(c *gin.Context) {
	fmt.Println("goods路由组中间件2")
}

func GroupRouterOrdersMiddle1(c *gin.Context) {
	fmt.Println("Orders路由组中间件1")
}

func GroupRouterOrdersMiddle2(c *gin.Context) {
	fmt.Println("Orders路由组中间件2")
}

func main() {
	r := gin.New()
	r.Use(gin.Logger())

    //curl 127.0.0.1:8080/goods/add
    /**
    goods路由组中间件1
	goods路由组中间件2
	/goods/add
    */
	goodsGroup := r.Group("/goods", GroupRouterGoodsMiddle1, GroupRouterGoodsMiddle2)
	{
		goodsGroup.GET("/add", func(ctx *gin.Context) {
			fmt.Println("/goods/add")
		})
	}
    r.Group("/goods", GroupRouterGoodsMiddle1, GroupRouterGoodsMiddle2).GET("/add", func(ctx *gin.Context) {
		fmt.Println("/goods/add")
	})
    
    //curl 127.0.0.1:8080/goods/add
    //控制台结果：/goods/add
	r.Group("/goods", GroupRouterGoodsMiddle1, GroupRouterGoodsMiddle2)
	r.GET("/goods/add", func(ctx *gin.Context) {
		fmt.Println("/goods/add")
	})
    
    
	orderGroup := r.Group("/order")
	orderGroup.Use(GroupRouterOrdersMiddle1, GroupRouterOrdersMiddle2)
	{
		orderGroup.GET("/add", func(ctx *gin.Context) {
			fmt.Println("/order/add")
		})

		orderGroup.GET("/del", func(ctx *gin.Context) {
			fmt.Println("/order/del")
		})

		//嵌套
		testGroup := orderGroup.Group("/test", func(ctx *gin.Context) {
			fmt.Println("/order/test下的中间件")
		})

		testGroup.GET("/test1", func(ctx *gin.Context) {
			fmt.Println("/order/test/test1下的函数")
		})

	}
	r.Run()
}
```



**结论：** 全局中间件 > 路由组中间件 > 路由中间件
 全局中间件最先执行