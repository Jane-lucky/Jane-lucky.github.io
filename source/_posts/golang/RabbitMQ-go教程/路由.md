---
title: (五) RabbitMQ go教程——路由（routing）
categories: 
- [golang, RabbitMQ-go教程]
tags:
- RabbitMQ

---



在之前的教程中，我们创建了一个小型的日志系统，可以给多个消费者广播一条消息。

本节可以消息发送到目标指定的接收者，比如说：对于日志系统来说，一般会存在这几类日志类型：errror、info、warning等，而我们可能仅对于error类型的错误需要存入磁盘中，其余的日志内容只需要打印出来就可以。

我们之前的有创建队列的绑定，该绑定与转换的格式相关，之前采用`fanout`类型的exchange，表示无差距的向队列传输消息。

绑定也可以通过routing ley来进行指定,具有选择的进行消息的传输

```go
err = ch.QueueBind(
  q.Name,    // queue name
  "black",   // routing key
  "logs",    // exchange
  false,
  nil)
```

绑定密钥的含义取决于交换器的类型，之前使用的`fanout`只是忽略了这个值。

# direct 交换器

我们扩展之前的类型，希望将不同类型的消息进行不同方式的处理。采用`direct`的方式：消息进入`binding key` 和`routing key`完全匹配的队列中。

## `send.go`

创建一个交换器

```go
package main

import (
	"context"
	"log"
	"os"
	"strings"
	"time"

	amqp "github.com/rabbitmq/amqp091-go"
)

//

//定义一个helper函数来接受处理错误
func failOnError(err error, msg string) {
	if err != nil {
		log.Panicf("%s:%s", msg, err)
	}
}

func main() {
	//连接rabbitMQ服务端
	conn, err := amqp.Dial("amqp://guest:guest@172.17.0.2:5672/")
	failOnError(err, "Failed to connect to RabbitMQ")
	defer conn.Close()

	//创建管道
	ch, err := conn.Channel()
	failOnError(err, "Failed to open a channel")
	defer ch.Close()

	//作为发送者，需要声明一个转换体

	err = ch.ExchangeDeclare(
		"logs_direct", //name
		"direct",      //type
		true,          //durable
		false,         //auto-delete
		false,         //internal
		false,         //no-wait
		nil,           //arguments
	)
	failOnError(err, "failed to declare a queue")

	//设置context包，可以轻松地将请求范围的值、取消信号和截止日期跨 API 边界传递给处理请求所涉及的所有 goroutine
	ctx, cancel := context.WithTimeout(context.Background(), time.Second*5)
	defer cancel()

	//定义的队列是幂等的，消息内容是byte数组
	body := bodyFrom(os.Args)
	//body := "Hello World"

	err = ch.PublishWithContext(ctx,
		"logs_direct",         //exchange
		severityFrom(os.Args), //routing key
		false,
		false,
		amqp.Publishing{
			ContentType: "text/plain",
			Body:        []byte(body),
		})
	failOnError(err, "Failed to publish a message")
	log.Printf("[x] Sent %s\n", body)
}

func bodyFrom(args []string) string {
	var s string
	if (len(args) < 2) || os.Args[1] == "" {
		s = "Hello"
	} else {
		s = strings.Join(args[1:], " ")
	}
	return s
}

func severityFrom(args []string) string {
	var s string
	if (len(args) < 2) || (os.Args[1] == "") {
		s = "info"
	} else {
		s = os.Args[1]
	}
	return s
}

```

## `recivce.go`

```go
package main

import (
	"log"
	"os"

	amqp "github.com/rabbitmq/amqp091-go"
)

func failOnError(err error, msg string) {
	if err != nil {
		log.Panicf("%s:%s", err, msg)
	}
}

func main() {
	//连接rabbitMQ服务端
	conn, err := amqp.Dial("amqp://guest:guest@172.17.0.2:5672/")
	failOnError(err, "Failed to connect to RabbitMQ")
	defer conn.Close()

	//创建管道
	ch, err := conn.Channel()
	failOnError(err, "Failed to open a channel")
	defer ch.Close()

	err = ch.ExchangeDeclare(
		"logs_direct", //name
		"direct",      //type
		true,          //durable
		false,         //auto-delete
		false,         //internal
		false,         //no-wait
		nil,           //arguments
	)
	failOnError(err, "failed to declare a queue")

	q, err := ch.QueueDeclare(
		"",
		false,
		false,
		true,
		false,
		nil,
	)
	failOnError(err, "failed to declare a queue")

	if len(os.Args) < 2 {
		log.Printf("Usage: %s [info] [waring] [error]", os.Args[0])
		os.Exit(0)
	}

	for _, s := range os.Args[1:] {
		log.Printf("Binding queue %s to exchange %s with routing key %s",
			q.Name, "logs_direct", s)
		err = ch.QueueBind(
			q.Name,        // queue name
			s,             // routing key
			"logs_direct", // exchange
			false,
			nil)
		failOnError(err, "Failed to bind a queue")
	}

	failOnError(err, "Failed to bind queue")

	//将告诉服务段请在队列中传输消息，我们将在管道中读取到该消息
	msgs, err := ch.Consume(
		q.Name,
		"",
		//false,
		true, //ack
		false,
		false,
		false,
		nil,
	)
	failOnError(err, "Failed to register a consumer")

	var forever chan struct{}
	//forever := make(chan bool)

	go func() {
		for d := range msgs {
			log.Printf("Received a message: %s", d.Body)
		}
	}()
	log.Printf(" [*] Waiting for messages. To exit press CTRL+C")
	<-forever
}

```

## 运行结果

```shell
ubuntu@root:~/go/src/gotest/recevice$ go run receive.go info warning error

ubuntu@root:~/go/src/gotest/recevice$ go run receive.go  warning error > logs_from_rabbit.log

ubuntu@root:~/go/src/gotest/send$ go run send.go error
2022/09/26 16:00:56 [x] Sent error
ubuntu@root:~/go/src/gotest/send$ go run send.go info
2022/09/26 16:03:08 [x] Sent info
ubuntu@root:~/go/src/gotest/send$ go run send.go warning
2022/09/26 16:03:17 [x] Sent warning
ubuntu@root:~/go/src/gotest/send$ go run send.go error

```

![runtime](路由/runtime.png)
